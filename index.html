<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="./assets/css/base.css" />
        <link rel="stylesheet" href="./assets/css/style.css" />
    </head>
    <body>
        <div class="app">
            <header class="header">
                <div class="header-grid grid">
                    <div class="header-left">
                        <div class="header-left__img">
                            <img src="./assets/img/logo.webp" alt="" />
                        </div>
                    </div>
                    <div class="header-main">
                        <div class="header-main__text">
                            ĐOÀN VIÊN THANH NIÊN KHOA CÔNG NGHỆ THÔNG TIN NHIỆT
                            LIỆT <br />
                            CHÀO MỪNG ĐẠI HỘI ĐẠI BIỂU ĐOÀN TNCS HỒ CHÍ MINH
                            <br />
                            KHOA CÔNG NGHỆ THÔNG TIN LẦN XI NHIỆM KỲ 2022 - 2024
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="header-right__img">
                            <img src="./assets/img/LOG-XI.png" alt="" />
                        </div>
                    </div>
                </div>
            </header>

            <section class="main">
                <div class="main-grid grid">
                    <div class="main-left">
                        <div class="main-left__wrap">
                            <img class="main-left__wrap-img" src="" alt="" />
                        </div>
                        <input class="main-left__inp" type="file" hidden />
                    </div>
                    <div class="main-right">
                        <div class="main-right__form">
                            <div class="main-right__form-group">
                                <div class="main-right__form-title">
                                    Thông điệp của bạn
                                </div>
                                <textarea
                                    class="main-right__form-input"
                                    name=""
                                    id=""
                                    cols="30"
                                    rows="10"
                                ></textarea>
                                <div class="main-right__form-count-char">
                                    <span class="count-char__now">0</span>
                                    /
                                    <span class="count-char__max">400</span>
                                </div>
                            </div>
                            <div class="main-right__form-group">
                                <div class="main-right__form-title">Ký tên</div>
                                <input
                                    type="text"
                                    class="main-right__form-input"
                                />
                                <div class="main-right__form-count-char">
                                    <span class="count-char__now">0</span>
                                    /
                                    <span class="count-char__max">40</span>
                                </div>
                            </div>
                            <div class="main-right__form-submit-btn">
                                Gửi thông điệp
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <footer class="footer">
                <div class="footer-grid grid">
                    <div class="footer-text">
                        &copy; 2018 Bản quyền thuộc về hội sinh viên Việt Nam
                        thành phố Hồ Chí Minh
                    </div>
                </div>
            </footer>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
            const $ = document.querySelector.bind(document);
            const $$ = document.querySelectorAll.bind(document);

            const avtLS = JSON.parse(localStorage.getItem("avtLS")) || "";

            const inputs = $$(".main-right__form-input");
            const mainLeftWrap = $(".main-left__wrap");

            //avt LS
            mainLeftWrap.querySelector("img").src = avtLS;

            inputs.forEach((input) => {
                input.oninput = function (e) {
                    const span =
                        this.parentElement.querySelector(".count-char__now");
                    const max = parseInt(
                        this.parentElement.querySelector(".count-char__max")
                            .innerHTML
                    );

                    const lengthInp = input.value.length;

                    if (lengthInp <= max) {
                        span.innerHTML = lengthInp;
                    } else {
                        this.blur();
                    }
                };
            });

            mainLeftWrap.onclick = function () {
                this.parentElement.querySelector(".main-left__inp").click();
            };

            $(".main-left__inp").onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = async () => {
                    await axios
                        .post("http://localhost:5000/user/upload-avt", {
                            data: reader.result,
                        })
                        .then((res) => {
                            localStorage.setItem(
                                "avtLS",
                                JSON.stringify(res.data)
                            );
                            mainLeftWrap.querySelector("img").src = res.data;
                        })
                        .catch((err) => {
                            console.log(err.response?.data);
                        });
                };
            };

            $(".main-right__form-submit-btn").onclick = async () => {
                const avt = mainLeftWrap.querySelector("img").src;
                const content = inputs[0].value;
                const name = inputs[1].value;
                if (avt && name && content) {
                    const data = {
                        avt,
                        name,
                        content,
                    };
                    
                    await axios
                        .post("http://localhost:5000/user/new-post", data)
                        .then((res) => {
                            window.location = "/home.html";
                        })
                        .catch((err) => console.log(err.response?.data));
                }
            };
        </script>
    </body>
</html>
